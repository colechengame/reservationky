# 🧾 派號邏輯開發結論（定錨版）

---

## 🎯 一、派號核心定義

- 🧩 **派號池 Key**
  - 日期 + 門市 + 診間 + 時段 + 會員
- 👤 **派號代表意義**
  - 代表「會員在該派號池中的排隊位置」
- 🔗 **派號綁定原則**
  - 派號 **綁會員，不綁單一預約**

---

## 📌 二、派號基本規則

### 1️⃣ 同一派號池只派一次號碼
- 同會員在同一派號池內  
- 不論有幾筆預約，只會有 **一個派號**

---

### 2️⃣ 同派號池內只「搬派號」，不重新派號
以下行為 **不會重新派號**，僅重新指定主預約：

- ➕ 新增更早預約
- ❌ 取消最早預約（但仍有其他預約存在）
- ❌ 取消非最早預約

➡️ 派號數字 **維持不變**

---

### 3️⃣ 派號主預約判定
- 🏷 **主預約定義**
  - 該會員在派號池內「最早的有效預約」
- 👁 **顯示規則**
  - 派號僅顯示於主預約
  - 其餘預約不顯示派號

---

## 🚪 三、離池判定（⚠️ 關鍵規則）

### 4️⃣ 完全離開派號池即作廢
- 若會員於任一時間點，在該派號池內：
  - **有效預約數 = 0**
- 👉 視為 **離開派號池**
- ❌ 原派號即作廢，不可回溯

---

### 5️⃣ 離池後重新進池需重新派號
以下情境皆視為「離池後重新進池」：

- 📅 跨日期
- ⏰ 跨時段
- 🏥 跨診間
- ❌ 全部預約取消後再新增

➡️ 需重新派發派號（接續派號池最後號碼）

---

### 6️⃣ 派號只會遞增，不回收
- 🗂 作廢派號僅保留歷史紀錄
- 🔁 不可重用、不回收
- ⚖️ 確保現場順序穩定，避免插隊爭議

---

## 🧠 四、判斷心法（實作唯一依據）

> 請判斷該會員在該派號池內  
> 是否曾出現「**有效預約數 = 0**」的時間點
>
> - ✅ 有 → 派號作廢，重新派號  
> - ❌ 無 → 僅搬派號，不重排

---

## 🧪 五、測試 Case（QA 驗收必過）

### Case 1｜新增單一預約
- 操作：新增 14:00
- 結果：派號 1

---

### Case 2｜新增更早預約（同池）
- 原本：16:00（1 號）
- 操作：新增 14:00
- 結果：14:00 顯示 1 號

---

### Case 3｜取消最早但仍有其他預約
- 原本：14:00（1 號）、15:00
- 操作：取消 14:00
- 結果：15:00 顯示 1 號

---

### Case 4｜取消最早後新增更早（不中斷）
- 原本：14:00（1 號）、15:00
- 操作：取消 14:00 → 新增 13:30
- 結果：13:30 顯示 1 號

---

### Case 5｜全取消後再新增
- 原本：14:00（1 號）
- 操作：取消 → 新增 13:30
- 結果：重新派號（不可回原號）

---

### Case 6｜同日跨時段再回來
- 原本：午診 14:00（1 號）
- 操作：改晚診 → 再改回午診
- 結果：午診重新派號

---

### Case 7｜取消非最早預約
- 原本：14:00（1 號）、15:00
- 操作：取消 15:00
- 結果：14:00 仍為 1 號

---

### Case 8｜連續新增多筆更早
- 原本：16:00（1 號）
- 操作：新增 15:00 → 新增 14:00
- 結果：14:00 顯示 1 號

---

### Case 9｜快速全取消再新增（秒級）
- 原本：14:00（1 號）
- 操作：取消 → 立即新增
- 結果：重新派號

---

### Case 10｜併發操作
- 操作：同時取消最早與新增更早
- 結果：
  - 僅存在一個派號
  - 主預約為最早時間

---

## ✅ 六、結論

- 🧩 派號只在同一派號池內保留  
- 🔄 同池內只搬派號，不重排  
- 💀 一旦離池，派號即死亡，不可回溯 
 


# **🏥 中醫預約號碼 \- 診間/時段/派號規格書**

# **🎯 核心目標**

單一欄位顯示預約所屬診間、時段及排序

格式：**{診間}/{時段}/{序號}**　　範例：**診一/早診/3**

# **⏰ 時段定義**⚠️ 時段外預約時間應於驗證層攔截，不進入派號流程

| 時段 | ⏱️ 起始 | ⏱️ 結束 |
| :---: | :---: | :---: |
| 早診 | 09:30:00 | 12:59:59 |
| 午診 | 13:00:00 | 16:59:59 |
| 晚診 | 17:00:00 | 21:00:00 |

# **🚪 診間定義** 📌 使用者預約時自行選擇，固定兩個診間不擴充

| 代碼 | 說明 |
| :---: | :---: |
| 診一 | 診間一 |
| 診二 | 診間二 |

🔢 派號規則

📐 序列單位

**門市 × 日期 × 時段 × 診間 \= 一組獨立奇數序列**

## **🏪 序列獨立範例（同一天）**

| 門市 | 診間 | 時段 | 序列 |
| :---: | :---: | :---: | :---: |
| 中壢京都堂 | 診一 | 午診 | 1, 3, 5, 7... |
| 中壢京都堂 | 診二 | 午診 | 1, 3, 5, 7... |
| 板橋京都堂 | 診一 | 午診 | 1, 3, 5, 7... |
| 板橋京都堂 | 診二 | 午診 | 1, 3, 5, 7... |
| 高雄合伸堂 | 診一 | 晚診 | 1, 3, 5, 7... |

🔄 四組完全獨立，互不影響

## **🔠 序號格式**

* 正整數，從 1 開始  
* 僅使用奇數：1, 3, 5, 7...  
* 不補零


## **📊 排序依據（優先順序）**

| 優先 | 欄位 | 規則 |
| :---: | :---: | :---: |
| 1️⃣ | created\_at | 早 → 晚 |
| 2️⃣ | id | 小 → 大 |

## **🔒 不可變原則**

| 規則 | 說明 |
| :---: | :---: |
| 🚫 序號不回收 | 取消的序號永久作廢 |
| 🚫 序號不重編 | 已派發的序號不變動 |
| ✅ 序號連續派發 | 依建立順序連續給奇數 |

# **🔄 取消與改期處理**

| 操作 | 處理方式 |
| :---: | ----- |
| ❌ 取消 | 原序號作廢，不影響他人序號 |
| 📅 改期 | 等同「取消 \+ 新建」，需重新排隊取得新序號 |

# **🧪 測試案例**

| \# | 情境 | 輸入 | 預期結果 |
| :---: | :---: | ----- | ----- |
| 1 | 基本排序 | 依序建立 11:00、09:30、10:00 | 11:00→早診/1、09:30→早診/3、10:00→早診/5 |
| 2 | 時段邊界 | 12:59 vs 13:00 | 12:59→早診、13:00→午診 |
| 3 | 時段邊界 | 16:59 vs 17:00 | 16:59→午診、17:00→晚診 |
| 4 | 同秒建立 | 兩筆 created\_at 相同 | 依 id 小→大排序 |
| 5 | 跨門市 | A店午診、B店午診 | 各自獨立從 1 開始 |
| 6 | 跨診間 | 診一/早診、診二/早診 | 各自獨立從 1 開始 |
| 7 | 取消不回收 | 序號 1,3,5 中 3 取消 | 新預約得 7，不是 3 |
| 8 | 改期重排 | 早診/3 改到午診 | 早診/3 作廢，取得午診新號 |
| 9 | 多次取消 | 序號 1,3,5 全取消 | 新預約得 7，不是 1 |

# **✅ 結論**
- 單一欄位清楚顯示診間、時段及排序
- 序號規則簡單明確，易於實作與維護
- 嚴格遵守不可變原則，確保現場秩序  
- 測試案例涵蓋多種情境，確保系統穩定性
- 為中醫預約系統提供穩定可靠的號碼派發機制
